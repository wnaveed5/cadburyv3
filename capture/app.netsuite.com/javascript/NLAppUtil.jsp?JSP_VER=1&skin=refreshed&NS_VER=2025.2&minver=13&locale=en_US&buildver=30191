










var NLDate_short_months = new Array("Jan","Feb","Mar",
	                                "Apr","May","Jun","Jul",
	                                "Aug","Sep","Oct","Nov","Dec");
if ( 13 > 12 )
	NLDate_short_months.push();

function getMachineByName(machineName)
{
    return getMachine(machineName);
}

function getMachine(machineName)
{
    if (window.machines)
        return window.machines[machineName];
    return null;
}


function getFieldSetDisplayText( mach, fldset, linenum, nohtml, sHideLabels )
{
	var sOutput = "";
	if ( nohtml == null )
		nohtml = false;

	var nCount = 0;
	for ( var i = 0; i < mach.countFormElements(); i++)
	{
		if ( mach.getFormElementFieldSet(i) != fldset )
			continue;
		nCount++;

		var curName = mach.getFormElementName(i);
		var curElement = mach.getFormElement(i);
		var curLabel = mach.getFormElementLabel(i);

		var dataCell = linenum == null ? getFormValue(curElement) : getEncodedValue(mach.name, linenum, curName);
		
		if (linenum == null && curElement != null)
		{
			var spanName = mach.name + "_" + (curName.indexOf( '_display' ) == -1 ? curName : mach.getFormElementName( i+1 )) + '_fs';
			var spanObj = document.getElementById( spanName );
			if (spanObj != null && spanObj.style.display == 'none')
			{
				dataCell = "";
			}
		}

		if (!isValEmpty(dataCell))
		{
			var curType = mach.getFormElementType(i);
			var bCheckBox = curType == 'checkbox';
            var bSelectBasedType = curType == 'select' || curType == 'slaveselect';
			var bWriteLabel = curLabel.length > 0 && (!bCheckBox || dataCell == 'T');
			var bWriteLineBreak = false;
			if ( bWriteLabel && (sHideLabels == null || sHideLabels.indexOf(curLabel) == -1))
			{
				sOutput += curLabel;
				if ( !bCheckBox )
					sOutput += ": ";
				bWriteLineBreak = true;
			}
            if (!bSelectBasedType)
            {
                dataCell = dataCell.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            }
			if ( !bCheckBox )
			{
				if ( mach.isElementPopupDisplayField(i) )
				{
					var pos = curName.indexOf("_display");
					var actualDataCell = linenum == null ? getFormValue(mach.getFormElement(i+1)) : getEncodedValue(mach.name, linenum, mach.getFormElementName(i+1));
                    if (!isValEmpty(actualDataCell) && !bSelectBasedType)
                    {
                        actualDataCell = actualDataCell.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    }
					if ( pos != -1 && !isValEmpty(actualDataCell) )
					{
						sOutput += dataCell.replace(/\u0005/g, ', ').replace(/\r/g,'').replace(/\n/g, ', ');
						bWriteLineBreak = true;
					}
				}
				else
				{
					bWriteLineBreak = true;
					if ( curType == "select" )
					{
						if ( isMultiSelect( curElement ) )
							sOutput += getmultiselectlisttext( curElement, dataCell );
						else
							sOutput += getlisttext( curElement, dataCell )  ;
					}
					else if (curType == "currency")
						sOutput += format_currency( parseFloat( dataCell ) );
					else if (curType == "radio")
						sOutput += getradiotext( curElement, dataCell );
					else if (curType == "namevaluelist")
						sOutput += getnamevaluelisttext( dataCell , ", " );
                    else if (curType == "timeselector")
                        sOutput += curElement.parentNode.controller.getTextForValue(dataCell);
					// handle all other field types (text, etc) - but never print out the popup multi-select label data
					else if (curType != "slaveselect" && curName.indexOf("_labels") == -1)
						sOutput += dataCell.replace(/\r/g,'').replace(/\r/g,'').replace(/\n/g, ", ");
					else
						bWriteLineBreak = false;
				}
			}

			if ( bWriteLineBreak )
				sOutput +=  nohtml ? " " : "<br>";
		}
	}
	return sOutput;
}



window.fieldnamesArray = {};



window.haslineitemgroupArray = {};

function hasLineItemGroup(machine_name)
{

 if( window.haslineitemgroupArray[machine_name] == null )
  window.haslineitemgroupArray[machine_name] = document.forms['main_form'].elements[machine_name+'data'] != null;
 return window.haslineitemgroupArray[machine_name];

}


function allowAddLines(machine_name)
{
	return hasMachine(machine_name);
}

function hasMachine(machine_name)
{
    return hasLineItemGroup(machine_name) && eval('typeof('+machine_name+'_machine)') != "undefined";
}

function isEditMachine(machine_name)
{
	return getMachine(machine_name) && (getMachine(machine_name).type == EDIT_MACHINE);
}


window.lineitemFieldTypeArray = {};

function getEncodedFieldType(machine_name, fieldname, useOrigType)
{
	if ( hasEncodedField(machine_name, fieldname) )
	{
		if ( window.lineitemFieldTypeArray[machine_name] == null || window.lineitemFieldTypeArray[machine_name][fieldname] == null )
		{
			window.lineitemFieldTypeArray[machine_name] = {};
			var aFields = splitIntoCells( document.forms['main_form'].elements[machine_name+'fields'].value );
			var aTypes = splitIntoCells( document.forms['main_form'].elements[machine_name+'types'].value );
			var origTypeElem = document.forms['main_form'].elements[machine_name + 'origtypes'];
			var origTypes = origTypeElem ? splitIntoCells(origTypeElem.value) : null;
			for ( var i = 0; i < aFields.length; i++ )
			{
				var type = aTypes[i];
				if (i > 0 && ( type == "slaveselect" || type == "integer" ) && aFields[i-1] == aFields[i]+"_display")
					type = (aTypes[i-1] == "textarea") ? "multiselect" : "select";
				window.lineitemFieldTypeArray[machine_name][aFields[i]] = type;
				if (origTypes && origTypes[i])
					window.lineitemFieldTypeArray[machine_name][aFields[i] + '_origtype'] = origTypes[i];
			}
		}
		if (useOrigType && window.lineitemFieldTypeArray[machine_name][fieldname + '_origtype'])
			fieldname += '_origtype';
		return window.lineitemFieldTypeArray[machine_name][fieldname]
	}
	return null;
}


window.lineitemFieldlabelArray = {};

function getEncodedFieldLabel(machine_name, fieldname)
{
	if ( hasEncodedField(machine_name, fieldname) )
	{
		if ( window.lineitemFieldlabelArray[machine_name] == null || window.lineitemFieldlabelArray[machine_name][fieldname] == null )
		{
			window.lineitemFieldlabelArray[machine_name] = {};
			var aFields = splitIntoCells( document.forms['main_form'].elements[machine_name+'fields'].value );
			var aLabels = splitIntoCells( document.forms['main_form'].elements[machine_name+'labels'].value );
			for ( var i = 0; i < aFields.length; i++ )
			{
				var label = aLabels[i];
				if (i > 0 && aFields[i-1] == aFields[i]+"_display")
					label = aLabels[i-1];
				window.lineitemFieldlabelArray[machine_name][aFields[i]] = label;
			}
		}
		return window.lineitemFieldlabelArray[machine_name][fieldname]
	}
	return null;
}


window.lineitemFieldParentArray = {};

function getEncodedFieldParent(machine_name, fieldname)
{
	if ( hasEncodedField(machine_name, fieldname) )
	{
		if ( window.lineitemFieldParentArray[machine_name] == null || window.lineitemFieldParentArray[machine_name][fieldname] == null )
		{
			window.lineitemFieldParentArray[machine_name] = {};
			var aFields = splitIntoCells( document.forms['main_form'].elements[machine_name+'fields'].value );
			var aParents = splitIntoCells( document.forms['main_form'].elements[machine_name+'parents'].value );
			for ( var i = 0; i < aFields.length; i++ )
			{
				window.lineitemFieldParentArray[machine_name][aFields[i]] = aParents[i];
			}
		}
		return window.lineitemFieldParentArray[machine_name][fieldname]
	}
	return null;
}



function getFieldLineNum(machine_name, fld)
{
	var fieldnames = getFieldNamesArray(machine_name);
    var fieldname = fld.name;
    var linenum = -1;

	for ( var i = 0; i < fieldnames.length; i++ )
    {
        var re = new RegExp("^"+fieldnames[i]+"([0-9]+)$");
   	    if ( re.test(fieldname) )
        {
            linenum = parseInt(RegExp.$1, 10);
            break;
        }
    }
	return linenum;
}
function getLineItemField(machine_name, fldname, linenum)
{
	var fld = null;
	var formname = machine_name + '_form';
	if ( getEncodedFieldType( machine_name, fldname ) == "radio" )
	{
		var radio = getFormElementViaFormName( formname, fldname );
		fld = radio[linenum-1]
	}
	else
		fld = getFormElementViaFormName( formname, fldname + ( linenum != null ? linenum : '' ) );
	return fld;
}



function getLineCount(machine_name)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.getNumRows();

    
    return doGetLineCount(machine_name);
}

function getLineArray(machine_name)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.getLineArray();

    
    return doGetLineArray(machine_name);
}

function getLineArrayLine(machine_name, linenum)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.getLineArrayLine(linenum);

    
    return doGetLineArrayLine(machine_name, linenum);
}

function setLineArray(machine_name, linearray)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setLineArray(linearray);
    else
        
        doSetLineArray(machine_name, linearray);
}

function setLineArrayLine(machine_name, linenum, linearray)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setLineArrayLine(linenum, linearray);
    else
        
        doSetLineArrayLine(machine_name, linenum, linearray);
}

function hasLineArray(machine_name)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.hasLineArray();

    
    return doHasLineArray(machine_name);
}

function setMachineContentUpdated(machine_name, bUpdated)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setContentUpdated(bUpdated);
}

function clearLineArray(machine_name)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.clearLineArray();
    else
        
        doClearLineArray(machine_name);
}


function Machine_deleteLineItems(name, start, end)
{
    var machine = getMachine(name);
    if (machine)
        return machine.deletelines(start, end);
    else
        return doDeleteLineItems(name, start, end);
}



 function Machine_clearLineItems(name, bNoFocus)
{
    var machine = getMachine(name);
    if (machine)
        return machine.removeAllLines(bNoFocus);
}

function writeLineArray(machine_name)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.writeLineArray();
    else
        
        doWriteLineArray(machine_name);
}

function getEncodedValue(machine_name, linenum, fieldname)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.getFieldValue(fieldname, linenum, true);

    
    return doGetEncodedValue(machine_name, linenum, fieldname);
}

function findEncodedValue(machine_name, fieldname, value)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.findEncodedValue(fieldname, value, true);

    
    return doFindEncodedValue(machine_name, fieldname, value);
}

function setEncodedValue(machine_name, linenum, fieldname, value)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setFieldValue(linenum, fieldname, value);
    else
        
        doSetEncodedValue(machine_name, linenum, fieldname, value);
}

function setEncodedValues(machine_name, linenum, form)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setEncodedValues(linenum, form);
    else
        
        doSetEncodedValues(machine_name, linenum, form);
}

function setFormValues(machine_name, linenum, form, fld_name, firefieldchanged)
{
    var machine = getMachine(machine_name);
    if (machine)
        machine.setFormValues(linenum, form, fld_name, firefieldchanged);
    else
        
        doSetFormValues(machine_name, linenum, form, fld_name, firefieldchanged);
}


function getEncodedFieldPosition(machine_name, fieldname)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.getFieldPosition(fieldname);

    return doGetEncodedFieldPosition(machine_name, fieldname);
}

function hasEncodedField(machine_name, fieldname)
{
    var machine = getMachine(machine_name);
    if (machine)
        return machine.hasEncodedField(fieldname);

	return doHasEncodedField(machine_name, fieldname);
}

function getFieldNamesArray(machine_name)
{
    return doGetFieldNamesArray(machine_name);
}

function syncMachineSegment(mach, frm, fromline, toline)
{
    var machine = getMachine(mach);
    if (machine)
        machine.updateFormElements(fromline, toline);

	if (fromline == -1) fromline = 1;
	if (toline == -1 || toline > document.forms[0].elements['next'+mach+'idx'].value-1) toline = document.forms[0].elements['next'+mach+'idx'].value-1;
	for (var i=fromline;i<=toline;i++)
		setFormValues(mach,i,frm);
}





function doGetLineCount(machine_name)
{
    return doGetLineArray(machine_name) != null ? doGetLineArray(machine_name).length : 0;
}


var MACHINE_NAME_PREPEND = "mch_";

window.linearrayArray = {};


function doGetLineArray(machine_name)
{

	var lineArrayIndex = MACHINE_NAME_PREPEND + machine_name;
	if( window.linearrayArray[lineArrayIndex] == null)
	{
		if ( hasLineItemGroup(machine_name) )
		{
			var linearray = splitIntoRows( document.forms['main_form'].elements[machine_name+'data'].value);
			var prevLineIds = window._prevLineIds && window._prevLineIds[machine_name];
			if (prevLineIds) {
				if (prevLineIds.length === linearray.length) {
					for (var i = 0; i < linearray.length; i++) {
						if (prevLineIds[i]) {
							linearray[i] = splitIntoCells(linearray[i]);
							linearray[i].lineInstanceId = prevLineIds[i];
						}
					}
				}
				window._prevLineIds[machine_name] = null;
			}
			window.linearrayArray[lineArrayIndex] = linearray;
		}
	}
	return window.linearrayArray[lineArrayIndex];

}

function doGetLineArrayLine(machine_name, linenum)
{

	var linearray = doGetLineArray(machine_name);
	if (linearray[linenum] != null && typeof linearray[linenum] == 'string')
		linearray[linenum] = splitIntoCells(linearray[linenum]);
	var linedata = linearray[linenum];
	if (linedata)
	{
		linedata.lineInstanceId = linedata.lineInstanceId || _doGetNewLineInstanceId();
	}
	return linearray[linenum];

}

function doSetLineArray(machine_name, linearray)
{

	var lineArrayIndex = MACHINE_NAME_PREPEND + machine_name;
	window.linearrayArray[lineArrayIndex] = linearray;

}

function doSetLineArrayLine(machine_name, linenum, line)
{
	var linearray = doGetLineArray(machine_name);

	linearray[linenum] = line;
    line.lineInstanceId = line.lineInstanceId || _doGetNewLineInstanceId();

}

function doHasLineArray(machine_name, linearray)
{
	return window.linearrayArray != null && window.linearrayArray[MACHINE_NAME_PREPEND + machine_name] != null;
}

function doClearLineArray(machine_name)
{
	if( window.linearrayArray != null )
	    window.linearrayArray[MACHINE_NAME_PREPEND + machine_name] = null;
}

function doWriteLineArray(machine_name)
{

	if( doHasLineArray(machine_name) )
	{
		var linearray = doGetLineArray(machine_name);
		doWriteLineArrayData(machine_name, linearray);
	}

}

function doWriteLineArrayData(machine_name, linearray)
{
    var lineids = [];
    if( linearray && linearray.length > 0)
    {
        for (var i=0; i<linearray.length; i++)
        {
            var lineid = null;
            if (linearray[i] != null && typeof(linearray[i]) != 'string')
            {
                lineid = linearray[i].lineInstanceId;
                linearray[i] = linearray[i].join(String.fromCharCode(1));
            }
            lineids.push(lineid);
        }
        document.forms['main_form'].elements[machine_name+'data'].value = doGetLineArray(machine_name).join(String.fromCharCode(2));
	}
    else
        document.forms['main_form'].elements[machine_name+'data'].value = "";

    (window._prevLineIds = window._prevLineIds || {})[machine_name] = lineids;

}

function doGetEncodedValue(machine_name, linenum, fieldname)
{
    var linedata = doGetLineArrayLine(machine_name, linenum-1);
    if( linedata == null )
         return null;
    var i = doGetEncodedFieldPosition(machine_name, fieldname);
     if (i != -1)
       return linedata[i];
    return '';
}

function doFindEncodedValue(machine_name, fieldname, value)
{
    var i = doGetEncodedFieldPosition(machine_name, fieldname);
    if (i == -1)
        return -1;
    for (var linenum=0;linenum < doGetLineCount(machine_name);linenum++)
    {
        var linedata = doGetLineArrayLine(machine_name,linenum);
        if (value == linedata[i])
            return linenum+1;
    }
    return -1;
}

function doSetEncodedValue(machine_name, linenum, fieldname, value)
{
    if ( !hasLineItemGroup(machine_name) )
		return;
    var linedata = doGetLineArrayLine(machine_name,linenum-1 );
    if ( linedata == null ) linedata = [];
    var i = doGetEncodedFieldPosition(machine_name, fieldname);
	if (i == -1)
		return;
	linedata[i] = value != null ? String(value) : "";
	doSetLineArrayLine(machine_name,linenum-1,linedata);
}


function doSetEncodedValues(machine_name, linenum, form)
{
    
	if ( !hasLineItemGroup(machine_name) )
		return;
	if ( form == null )
		form = document.forms[machine_name+'_form'];

    var fieldnames = doGetFieldNamesArray(machine_name);
    var fieldflags = splitIntoCells( document.forms['main_form'].elements[machine_name+'flags'].value );
    var linedata = new Array(fieldnames.length);
    var olddata = getLineArrayLine(machine_name,linenum-1);

    for (var i=0; i < fieldnames.length; i++)
    {
        if ( isValEmpty( fieldnames[i] ) )
            continue;
        if ((fieldflags[i] & 4) == 0)
            linedata[i] = olddata[i];
        else
        {
            var fld;
			if (form.elements[fieldnames[i]] != null && form.elements[fieldnames[i]][0] != null && form.elements[fieldnames[i]][0].type == "radio")
			{
				for ( var j = 0; j < form.elements[fieldnames[i]].length; j++ )
					if ( form.elements[fieldnames[i]][j].value == linenum )
						fld = form.elements[fieldnames[i]][j]
			}
			else if ((fieldflags[i] & 8) != 0)
                fld = form.elements[fieldnames[i+1]+linenum.toString()+"_display"];
            else
                fld = form.elements[fieldnames[i]+linenum.toString()];
            if (fld != null)
			{
				if (fld.type == "checkbox" || fld.type == "radio")
					linedata[i] = fld.checked ? 'T' : 'F';
				else if (fld.type == "select-one")
					linedata[i] = fld.options[fld.selectedIndex].value;
				else if (fld.type == "textarea")
					linedata[i] = fld.value.replace(/\r/g,'').replace(/\n/g,String.fromCharCode(5));
				else
					linedata[i] = fld.value;
			}
            else
                linedata[i] = olddata[i];
 		}
    }
	setLineArrayLine(machine_name,linenum-1,linedata);
}


function doSetFormValues(machine_name, linenum, form, fld_name, firefieldchanged)
{
    
	if ( !hasLineItemGroup(machine_name) || isEditMachine(machine_name) )
		return;

    var fieldnames = doGetFieldNamesArray(machine_name);
    var fieldflags = splitIntoCells( document.forms['main_form'].elements[machine_name+'flags'].value );
    var linedata = getLineArrayLine(machine_name, linenum-1);

    for (var i=0; i < fieldnames.length; i++)
    {
        if ( isValEmpty( fieldnames[i] ) || ( fld_name != null && fieldnames[i] != fld_name ) )
            continue;
        if ((fieldflags[i] & 4) != 0)
        {
            var fld;
            if (form.elements[fieldnames[i]] != null && form.elements[fieldnames[i]][0] != null && form.elements[fieldnames[i]][0].type == "radio")
                fld = form.elements[fieldnames[i]][linenum-1];
            else if ((fieldflags[i] & 8) != 0)
                fld = form.elements[fieldnames[i+1]+linenum.toString()+"_display"];
            else
                fld = form.elements[fieldnames[i]+linenum.toString()];

            if (fld != null)
            {
                if (fld.type == "radio")
                {
                    fld.checked = linedata[i] == 'T';
                }
                else if (fld.type == "checkbox")
                {
                    setFormValue(fld, linedata[i] == 'T');
                }
                else if (fld.type == "textarea")
                {
                    fld.value = linedata[i].replace(/\u0005/g, '\n');
                }
                else if (fld.type == "hidden")
                {
                    var displayField = getFormElement(fld.form, fld.name+'_display' );
                    setFormValue(fld, linedata[i], displayField ? displayField.value : null, firefieldchanged);
                } else
                {
                    setFormValue(fld, linedata[i], null, firefieldchanged);
                }
            }
        }
    }
}


function doDeleteLineItems(name, start, end)
{
    var machine = eval(name+'_machine');
    var linearray = getLineArray(machine.name);
    setLineArray(machine.name,linearray.slice(0,start).concat(linearray.slice(end)));
    machine.setIndex( machine.getNextIndex() - (end - start) );
    return true;
}

function doGetEncodedFieldPosition(machine_name, fieldname)
{
    var fieldnames = doGetFieldNamesArray(machine_name);
	if ( fieldnames != null )
	{

 return fieldnames[fieldname] != null ? fieldnames[fieldname] : -1;

}
	return -1;
}

function doHasEncodedField(machine_name, fieldname)
{
    if (doGetEncodedFieldPosition(machine_name, fieldname) < 0)
		return false;
	return true;
}

function doGetFieldNamesArray(machine_name)
{

    if( window.fieldnamesArray[machine_name] == null )
    {
        if ( document.forms['main_form'].elements[machine_name+'fields'] != null )
        {
            window.fieldnamesArray[machine_name] = splitIntoCells( document.forms['main_form'].elements[machine_name+'fields'].value );
            for (var i=0; i < window.fieldnamesArray[machine_name].length; i++)
                window.fieldnamesArray[machine_name][window.fieldnamesArray[machine_name][i]] = i
        }
    }
 return window.fieldnamesArray[machine_name];

}

function doGetWrongFieldVisibilities(url)
{
    var origFieldVisibilities = nlapiServerCall(url, 'getItemFieldVisibilities', []);
    var fieldNames = doGetFieldNamesArray('item');
    var fieldNamesLength = fieldNames.length;
    var wrongFieldVisibilities = {};
    for (var i = 0; i < fieldNamesLength; i++)
    {
        var field = nlapiGetLineItemField("item", fieldNames[i]);
        if (!!field && origFieldVisibilities.hasOwnProperty(fieldNames[i]))
        {
            if (origFieldVisibilities[fieldNames[i]] && !field.isHidden())
                wrongFieldVisibilities[fieldNames[i]] = false;
            else if (!origFieldVisibilities[fieldNames[i]] && field.isHidden())
                wrongFieldVisibilities[fieldNames[i]] = true;
        }
    }
    return wrongFieldVisibilities;
}

function _doGetNewLineInstanceId()
{
    function randomHexStr(length)
    {
        var result = '';
        while(result.length < length)
        {
            result += toHex(getRandomValue());
        }
        return result;
    }
    function getRandomValue()
    {
        return Math.floor(Math.random() * 16);
    }
    function toHex(value)
    {
        return value.toString(16);
    }
    return randomHexStr(8) + '-' + randomHexStr(4) + '-' + '4' + randomHexStr(3) + '-' + toHex(getRandomValue() & 11 | 8) + randomHexStr(3) + '-' + randomHexStr(12);
}

function _getLineInstanceIds(machine_name)
{
    var result = [];
    var linearray = doGetLineArray(machine_name);
    if (linearray)
    {
        for (var i = 0; i < linearray.length; i++)
        {
            var linedata = doGetLineArrayLine(machine_name, i);
            result.push(linedata.lineInstanceId);
        }
    }
    return result;
}

function _getLineIndexForInstanceId(machine_name, lineInstanceId)
{
    var linearray = doGetLineArray(machine_name);
    if (linearray)
    {
        for (var i = 0; i < linearray.length; i++)
        {
            var linedata = doGetLineArrayLine(machine_name, i);
            if (linedata.lineInstanceId === lineInstanceId)
            {
                return i;
            }
        }
    }
    return -1;
}


var NS = false ? (NS || {}) : (window.NS || {});
NS.UI = NS.UI || {};
NS.UI.AppUtil = NS.UI.AppUtil || {
	isBackendRequest: false,
    timeSelectorToRangeMapJSName: 'timeSelectors',
	contentBodyHeight: parseInt('body.scrollHeight'),
    contentBodyWidth: parseInt('contentTable.scrollWidth'),
    fieldHighlightScroll: 'scrollfield'
};

if (!NS.UI.AppUtil.isBackendRequest) {
    var ERR_HELP_SESSION_TIMEOUT_MSG = 'Help is unavailable because your connection has timed out.\nPlease log in to the application and open the help window again.';
}
var ns_domain = 'https://system.na20.netsuite.com';

NLAlertDialog.CONFIRMATION = 0;
NLAlertDialog.INFORMATION  = 1;
NLAlertDialog.WARNING      = 2;
NLAlertDialog.ERROR        = 3;
NLAlertDialog.defaultTitles = ["Confirmation",
                               "Information",
                               "Warning",
                               "Error"];

/**
 * @deprecated Use @var NLAlertDialog.CONFIRMATION instead.
 */
NLAlertDialog.TYPE_LOWEST_PRIORITY = 0;
/**
* @deprecated Use @var NLAlertDialog.INFORMATION instead.
*/
NLAlertDialog.TYPE_LOW_PRIORITY    = 1;
/**
* @deprecated Use @var NLAlertDialog.WARNING instead.
*/
NLAlertDialog.TYPE_MEDIUM_PRIORITY = 2;
/**
* @deprecated Use @var NLAlertDialog.ERROR instead.
*/
NLAlertDialog.TYPE_HIGH_PRIORITY   = 3;

function validate_fromaddress(fld)
{
    if (fld.value.length > 0 && !fld.value.toLowerCase().match(/^\"[^<>"]+\"\s\<(?:(?:[-a-zA-Z0-9!#$%&'*+/=?^_`{|}~]+(?:\.[-a-zA-Z0-9!#$%&'*+/=?^_`{|}~]+)*@(?:[a-zA-Z0-9]+(?:-+[a-zA-Z0-9]+)*\.)+(?:xn--[-a-zA-Z0-9]+|[a-zA-Z]{2,16}))|(?:\{[A-Za-z0-9_\.]+\}))\>$/))
    {
        alert('From address must be of the form \"Name\" <Email Address>');
        selectAndFocusField(fld);
        NS.form.setValid(false);
        return false;
    }
    NS.form.setValid(true);
    return true;
}


    function showAlertBox(elemId, sTitle, sMessage, iType, width, helpUrl, helpText)
{
    NS.jQuery('#' + elemId).html(getAlertBoxHtml(sTitle, sMessage, iType, width, helpUrl, helpText)).show();
}

function hideAlertBox(elemId)
{
    NS.jQuery("#"+elemId).hide();
}



var doPageLogging = (window.parent == null || window.parent == window);
var doPerfdbLogging = window.doPageLogging;

var isProdsys = true;
var pageEndToEndTime = null; 
var e2eResultsString = null; 
var performanceResultsAsTable = null;

function storePerfCookie()
{
    var m = /(^| )base_t=([^;]+)/.exec(document.cookie);
    document.cookie = 'base_t=; path=/';

    sessionStorage.removeItem('perfCookie');
    sessionStorage.removeItem('nthreadid');
    sessionStorage.removeItem('soperationid');
    sessionStorage.removeItem('soperationid2');
    sessionStorage.removeItem('whence');
    sessionStorage.removeItem('method');
    sessionStorage.removeItem('url');

    if (m)
    {
        sessionStorage.setItem('perfCookie', m[2]);
        var cookie = m[2];
        var perfInfo = {}, n;
        var rx = /(\w+):([^|]*)/g;
        while (n = rx.exec(cookie)) {
            perfInfo[n[1]] = unescape(n[2]);
        }
        if (perfInfo.start && perfInfo.url
            && window.location.href.indexOf(perfInfo.url2 || perfInfo.url) != -1)
        {
            if (perfInfo.nthreadid)
                sessionStorage.setItem('nthreadid', perfInfo.nthreadid);
            if (perfInfo.soperationid)
                sessionStorage.setItem('soperationid', perfInfo.soperationid);
            if (perfInfo.soperationid2)
                sessionStorage.setItem('soperationid2', perfInfo.soperationid2);
            if (perfInfo.whence)
                sessionStorage.setItem('whence', perfInfo.whence);
            if (perfInfo.method)
                sessionStorage.setItem('method', perfInfo.method);
            if (perfInfo.url2) // store only the url different from window.location.href
                sessionStorage.setItem('url', perfInfo.url);
        }
    }
}

function logEndOfRequest()
{
    if ( !window.doPageLogging ) return;
    try
    {
        var renderendtime = new Date();
        var endtoendTime = null;

        var perfInfo = {}, m;
        var rx = /(\w+):([^|]*)/g;
        var cookie = sessionStorage.getItem('perfCookie');
        if (cookie) {
            while (m = rx.exec(cookie))
                perfInfo[m[1]] = unescape(m[2]);
        }
        
        if (window.performance && window.performance.timing)
        {
            var navStart = window.performance.timing.navigationStart;
            if (navStart > 0)
            {
                perfInfo.start = navStart;
            }
        }
        var base_t = perfInfo.start;
        var base_t_url = perfInfo.url;
        var base_t_url2 = perfInfo.url2;
        var base_t_sql = nvl(perfInfo.sqlcalls,0);
        var base_t_sqltime = perfInfo.sqltime;
        var base_t_servertime = perfInfo.servertime;
        var base_t_ssstime = perfInfo.ssstime;
        var base_t_swftime = perfInfo.swftime;
        var base_t_user_email = perfInfo.email;
        var base_t_fcalls = perfInfo.fcalls;
        var base_t_ftime = perfInfo.ftime;

        if (base_t && base_t_url && document.location.href.indexOf(base_t_url2 || base_t_url) != -1)
        {
            endtoendTime = renderendtime.getTime() - base_t;
            window.pageEndToEndTime = endtoendTime;
        }

        var pageloadTime = window.headerstarttime != null ? renderendtime.getTime() - window.headerstarttime.getTime() : 0;
        var pageinitTime = window.pageinitstart != null ? (renderendtime.getTime() - window.pageinitstart.getTime()) : 0;
        var headerTime = window.headerstarttime != null ? (window.headerendtime.getTime() - window.headerstarttime.getTime()) : 0;
        var staticscriptTime = window.staticscriptstarttime != null ? (window.staticscriptendtime.getTime() - window.staticscriptstarttime.getTime()) : 0;
        var dynamicscriptTime = window.dynamicscriptstarttime != null ? (window.dynamicscriptendtime.getTime() - window.dynamicscriptstarttime.getTime()) : 0;
        var footerscriptTime = window.footerscriptstarttime != null ? (window.footerscriptendtime.getTime() - window.footerscriptstarttime.getTime()) : 0;
        var unmeasuredTime = pageloadTime - pageinitTime - headerTime - staticscriptTime - dynamicscriptTime - footerscriptTime - (window.dropdownCounter > 0 ? window.dropdownloadtime : 0);

        var resultsAsTable = [];
        if ( endtoendTime != null )
        {
            resultsAsTable = addPetDataRow(resultsAsTable, 'Total', (endtoendTime/1000));

            if ( window.isProdsys )
            {
                resultsAsTable = addPetDataRow(resultsAsTable, 'Server', ((base_t_servertime)/1000) + ' ('+format_currency(100*(base_t_servertime)/endtoendTime)+'%)');
                if (base_t_ssstime != null)
                    resultsAsTable = addPetDataRow(resultsAsTable, 'Server Suite Script', (base_t_ssstime/1000) + ' ('+format_currency(100*base_t_ssstime/endtoendTime)+'%)');
                if (base_t_swftime != null)
                    resultsAsTable = addPetDataRow(resultsAsTable, 'Server Workflow', (base_t_swftime/1000) + ' ('+format_currency(100*base_t_swftime/endtoendTime)+'%)');
                resultsAsTable = addPetDataRow(resultsAsTable, 'Network', ((endtoendTime-base_t_servertime-pageloadTime)/1000) + ' ('+format_currency(100*(endtoendTime-base_t_servertime-pageloadTime)/endtoendTime)+'%)');
                resultsAsTable = addPetDataRow(resultsAsTable, 'Client', (pageloadTime/1000) + ' ('+format_currency(100*pageloadTime/endtoendTime)+'%)');
            }
            else
            {
                resultsAsTable = addPetDataRow(resultsAsTable, 'Java', ((base_t_servertime-base_t_sqltime)/1000) + ' ('+format_currency(100*(base_t_servertime-base_t_sqltime)/endtoendTime)+'%)');
                if (base_t_ssstime != null)
                    resultsAsTable = addPetDataRow(resultsAsTable, 'SSS', (base_t_ssstime/1000) + ' ('+format_currency(100*base_t_ssstime/endtoendTime)+'%)');
                if (base_t_swftime != null)
                    resultsAsTable = addPetDataRow(resultsAsTable, 'SWF', (base_t_swftime/1000) + ' ('+format_currency(100*base_t_swftime/endtoendTime)+'%)');
                resultsAsTable = addPetDataRow(resultsAsTable, 'SQL', (base_t_sqltime/1000) + ' ('+format_currency(100*base_t_sqltime/endtoendTime)+'%) ('+base_t_sql+' call'+(base_t_sql == 1 ? '' : 's')+')');
                resultsAsTable = addPetDataRow(resultsAsTable, 'Fetches', (base_t_ftime/1000) + ' ('+base_t_fcalls+' call'+(base_t_fcalls == 1 ? '' : 's')+')');
                resultsAsTable = addPetDataRow(resultsAsTable, 'Network', ((endtoendTime-base_t_servertime-pageloadTime)/1000) + ' ('+format_currency(100*(endtoendTime-base_t_servertime-pageloadTime)/endtoendTime)+'%)');
                resultsAsTable = addPetDataRow(resultsAsTable, 'Client', (pageloadTime/1000) + ' ('+format_currency(100*pageloadTime/endtoendTime)+'%)');
            }
        }
        else
            resultsAsTable = addPetDataRow(resultsAsTable, 'Client', (pageloadTime/1000));

        if ( !window.isProdsys )
        {
            resultsAsTable = addPetDataRow(resultsAsTable, 'Header', (headerTime/1000) + ' ('+format_currency(100*headerTime/pageloadTime)+'%)');
            resultsAsTable = addPetDataRow(resultsAsTable, 'Static', (staticscriptTime/1000) + ' ('+format_currency(100*staticscriptTime/pageloadTime)+'%)');
            resultsAsTable = addPetDataRow(resultsAsTable, 'Dynamic', (dynamicscriptTime/1000) + ' ('+format_currency(100*dynamicscriptTime/pageloadTime)+'%)');
            resultsAsTable = addPetDataRow(resultsAsTable, 'Footer', (footerscriptTime/1000) + ' ('+format_currency(100*footerscriptTime/pageloadTime)+'%)');
            resultsAsTable = addPetDataRow(resultsAsTable, 'Selects', (window.dropdownloadtime/1000) + ' ('+format_currency(100*window.dropdownloadtime/pageloadTime)+'%) ('+window.dropdownCounter+' dropdown'+(window.dropdownCounter != 1 ? 's' : '')+')');

            var machinePerfInfo = window.editmachineCounter > 0 ? '('+ window.editmachineCounter+' machine'+(window.editmachineCounter != 1 ? 's' : '')+': '+(window.editmachineConstructorTime/1000) + ')' : '';
            resultsAsTable = addPetDataRow(resultsAsTable, 'PageInit', (pageinitTime/1000) + ' ('+format_currency(100*pageinitTime/pageloadTime)+'%) '+machinePerfInfo);
            resultsAsTable = addPetDataRow(resultsAsTable, 'Other', (unmeasuredTime/1000) + ' ('+format_currency(100*unmeasuredTime/pageloadTime)+'%)');
        }

        resultsAsTable = addPetDataRow(resultsAsTable,'Page', emptyIfNull( base_t_url ));
        resultsAsTable = addPetDataRow(resultsAsTable,'Email', emptyIfNull( base_t_user_email ));
        resultsAsTable = addPetDataRow(resultsAsTable,'Time', getdatestring(renderendtime)+' '+gettimestring(renderendtime)+' GMT '+(renderendtime.getTimezoneOffset() > 0 ? '+' : '')+(renderendtime.getTimezoneOffset()/60));

        performanceResultsAsTable = resultsAsTable;

        if ( window.doPerfdbLogging && endtoendTime != null && parseInt(endtoendTime) > (parseInt(pageloadTime) + parseInt(base_t_servertime)) )
        {
            if ( window.headerstarttime != null )
            {
                perfInfo['header'] = headerTime;
                perfInfo['pageload'] = pageloadTime;
            }
            if ( window.pageinitstart != null )
                perfInfo['pageinit'] = pageinitTime;
            if ( window.staticscriptstarttime != null )
                perfInfo['staticscript'] = staticscriptTime;
            if ( window.dynamicscriptTime != null )
                perfInfo['dynamicscript'] = dynamicscriptTime;
            if ( window.footerscriptTime != null )
                perfInfo['footerscript'] = footerscriptTime;
            perfInfo['endtoend'] = endtoendTime;
            new NLXMLHttpRequest( true ).requestURL( '/app/PerfRenderTime.nl', perfInfo, null, true )
        }
    }
    catch ( e ) { }   

    function addPetDataRow(data, colName, colValue)
    {
        data.push({
            name: colName,
            value: colValue,
        });
        return data;
    }
}


var loggedBeforeUnload = false;
function logStartOfRequest( type )
{
    if ( window.doPageLogging )
    {
        if ( type != 'onunload' || !window.loggedBeforeUnload )
        {
            var start = new Date().getTime();
            var whence = document.location.href.substring( document.location.href.indexOf( document.location.pathname ) );
            document.cookie = 'base_t=start:'+start+'|whence:'+escape(whence)+'; path=/';
        }
        window.loggedBeforeUnload = (type == 'beforeonunload');
    }
}

function setStartOfRequestLoggers( )
{
    if ( window.doPageLogging )
    {
        window.addEventListener('beforeunload', function() {
            logStartOfRequest('beforeonunload');
        });
    }
}

